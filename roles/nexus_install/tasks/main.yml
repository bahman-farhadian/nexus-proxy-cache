---
- name: Ensure nexus group exists
  ansible.builtin.group:
    name: "{{ nexus_group }}"
    system: true
    state: present

- name: Ensure nexus user exists
  ansible.builtin.user:
    name: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    system: true
    # Sonatype requires a valid shell for the process user.
    shell: /bin/bash
    home: "{{ nexus_install_dir }}"
    create_home: false
    state: present

- name: Ensure Nexus install directory exists
  ansible.builtin.file:
    path: "{{ nexus_install_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure Nexus data directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    mode: "0750"
  loop:
    - "{{ nexus_data_dir }}"
    - "{{ nexus_data_dir }}/etc"
    - "{{ nexus_data_dir }}/etc/fabric"

- name: Ensure Nexus launcher legacy work parent directory exists
  ansible.builtin.file:
    path: "{{ nexus_install_dir }}/sonatype-work"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Check Nexus launcher legacy work path type
  ansible.builtin.stat:
    path: "{{ nexus_install_dir }}/sonatype-work/nexus3"
  register: nexus_legacy_work_path
  changed_when: false

- name: Point legacy Nexus work path to configured data directory when absent
  ansible.builtin.file:
    src: "{{ nexus_data_dir }}"
    dest: "{{ nexus_install_dir }}/sonatype-work/nexus3"
    state: link
    force: false
  when: not nexus_legacy_work_path.stat.exists

- name: Re-point legacy Nexus work symlink when target differs
  ansible.builtin.file:
    src: "{{ nexus_data_dir }}"
    dest: "{{ nexus_install_dir }}/sonatype-work/nexus3"
    state: link
    force: true
  when:
    - nexus_legacy_work_path.stat.islnk | default(false)
    - (nexus_legacy_work_path.stat.lnk_source | default('')) != nexus_data_dir

- name: Ensure ownership on existing legacy Nexus work directory
  ansible.builtin.file:
    path: "{{ nexus_install_dir }}/sonatype-work/nexus3"
    state: directory
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    mode: "0750"
    recurse: true
  when:
    - nexus_legacy_work_path.stat.exists
    - nexus_legacy_work_path.stat.isdir

- name: Ensure Nexus legacy configuration directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    mode: "0750"
  loop:
    - "{{ nexus_install_dir }}/sonatype-work/nexus3/etc"
    - "{{ nexus_install_dir }}/sonatype-work/nexus3/etc/fabric"

- name: Download Nexus OSS archive
  ansible.builtin.get_url:
    url: "{{ nexus_download_url }}"
    dest: "/tmp/{{ nexus_archive_name }}"
    mode: "0644"
    checksum: "{{ nexus_download_checksum if (nexus_download_checksum | length > 0) else omit }}"
    force: false

- name: Extract Nexus OSS archive
  ansible.builtin.unarchive:
    src: "/tmp/{{ nexus_archive_name }}"
    dest: "{{ nexus_install_dir }}"
    remote_src: true
    creates: "{{ nexus_install_dir }}/nexus-{{ nexus_version }}"

- name: Ensure Nexus release tree ownership
  ansible.builtin.file:
    path: "{{ nexus_install_dir }}/nexus-{{ nexus_version }}"
    state: directory
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    recurse: true

- name: Point current symlink to selected Nexus version
  ansible.builtin.file:
    src: "{{ nexus_install_dir }}/nexus-{{ nexus_version }}"
    dest: "{{ nexus_install_dir }}/current"
    state: link
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    force: true

- name: Configure nexus.rc
  ansible.builtin.template:
    src: nexus.rc.j2
    dest: "{{ nexus_install_dir }}/current/bin/nexus.rc"
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    mode: "0644"
  register: nexus_rc_file

- name: Ensure Nexus configuration parent directories exist before templating
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    mode: "0750"
  loop:
    - "{{ nexus_data_dir }}/etc"
    - "{{ nexus_data_dir }}/etc/fabric"
    - "{{ nexus_install_dir }}/sonatype-work/nexus3/etc"
    - "{{ nexus_install_dir }}/sonatype-work/nexus3/etc/fabric"

- name: Configure nexus.properties in all Nexus config paths
  ansible.builtin.template:
    src: nexus.properties.j2
    dest: "{{ item }}"
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    mode: "0640"
  loop:
    - "{{ nexus_data_dir }}/etc/nexus.properties"
    - "{{ nexus_install_dir }}/sonatype-work/nexus3/etc/nexus.properties"
  register: nexus_properties_files

- name: Configure Nexus secrets encryption key file
  ansible.builtin.template:
    src: nexus-secrets.json.j2
    dest: "{{ nexus_secrets_file }}"
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    mode: "0640"
  register: nexus_secrets_file_cfg
  when: nexus_manage_custom_encryption_key | bool

- name: Configure Nexus PostgreSQL store properties in all Nexus config paths
  ansible.builtin.template:
    src: nexus-store.properties.j2
    dest: "{{ item }}"
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    mode: "0640"
  loop:
    - "{{ nexus_data_dir }}/etc/fabric/nexus-store.properties"
    - "{{ nexus_install_dir }}/sonatype-work/nexus3/etc/fabric/nexus-store.properties"
  register: nexus_store_properties_files
  when: nexus_database_backend == "postgresql"

- name: Remove Nexus store properties when not using PostgreSQL
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ nexus_data_dir }}/etc/fabric/nexus-store.properties"
    - "{{ nexus_install_dir }}/sonatype-work/nexus3/etc/fabric/nexus-store.properties"
  register: nexus_store_properties_absent
  when: nexus_database_backend != "postgresql"

- name: Tune Nexus JVM initial heap size
  ansible.builtin.lineinfile:
    path: "{{ nexus_install_dir }}/current/bin/nexus.vmoptions"
    regexp: "^-Xms"
    line: "-Xms{{ nexus_jvm_xms }}"
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    mode: "0644"
  register: nexus_vmoptions_xms

- name: Tune Nexus JVM maximum heap size
  ansible.builtin.lineinfile:
    path: "{{ nexus_install_dir }}/current/bin/nexus.vmoptions"
    regexp: "^-Xmx"
    line: "-Xmx{{ nexus_jvm_xmx }}"
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    mode: "0644"
  register: nexus_vmoptions_xmx

- name: Tune Nexus JVM direct memory size
  ansible.builtin.lineinfile:
    path: "{{ nexus_install_dir }}/current/bin/nexus.vmoptions"
    regexp: "^-XX:MaxDirectMemorySize="
    line: "-XX:MaxDirectMemorySize={{ nexus_jvm_max_direct_memory }}"
    owner: "{{ nexus_user }}"
    group: "{{ nexus_group }}"
    mode: "0644"
  register: nexus_vmoptions_direct

- name: Check whether nexus.service is already installed
  ansible.builtin.stat:
    path: /etc/systemd/system/nexus.service
  register: nexus_systemd_unit

- name: Restart Nexus when install-time config changes
  ansible.builtin.systemd_service:
    name: nexus
    state: restarted
  when:
    - nexus_systemd_unit.stat.exists
    - nexus_rc_file.changed
      or (
        nexus_properties_files is defined
        and (
          nexus_properties_files.results
          | selectattr('changed', 'equalto', true)
          | list
          | length
        ) > 0
      )
      or (nexus_secrets_file_cfg is defined and nexus_secrets_file_cfg.changed)
      or (
        nexus_store_properties_files is defined
        and (
          nexus_store_properties_files.results
          | selectattr('changed', 'equalto', true)
          | list
          | length
        ) > 0
      )
      or (
        nexus_store_properties_absent is defined
        and (
          nexus_store_properties_absent.results
          | selectattr('changed', 'equalto', true)
          | list
          | length
        ) > 0
      )
      or nexus_vmoptions_xms.changed
      or nexus_vmoptions_xmx.changed
      or nexus_vmoptions_direct.changed
